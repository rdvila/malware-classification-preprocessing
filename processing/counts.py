#!/usr/bin/env python

from sklearn.feature_selection import chi2, SelectKBest
import os
import sys
import glob
from cloudpickle import dumps
import dask.dataframe as ddf
import time
import argparse

labels = ['adware', 'flooder', 'ransomware', 'dropper', 'spyware', 'packed',
          'crypto_miner', 'file_infector', 'installer', 'worm', 'downloader']

prefix = "/opt/ml"

def log_container_info():
    print('------------------- environment variables -------------------')
    print(os.environ)
    print('------------------- environment variables -------------------')
    print('------------------- arguments -------------------')
    print(sys.argv)
    print('------------------- arguments -------------------')
    print('------------------- filesystem -------------------')
    for filename in glob.iglob(prefix + '**/**', recursive=True):
        print(filename)
    print('------------------- filesystem -------------------')


def process(args):
    print('Started the processing.')
    y = ddf.read_parquet(f"{prefix}/processing/data/{args.name}", compression="snappy", columns=labels)
    for label in labels:       
        counts = y[label].value_counts().compute()
        print(counts)
        print(f"save counts for {label}")
        with open(f"{prefix}/processing/output/counts-{label}.pkl", "wb") as f:
            f.write(dumps(counts))

    print('Finish the processing.')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("-name", type=str, default='train')
    args = parser.parse_args()

    log_container_info()
    process(args)

    sys.exit(0)
