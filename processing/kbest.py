#!/usr/bin/env python

from sklearn.feature_selection import chi2, SelectKBest
import os
import sys
import glob
from cloudpickle import dumps
import dask.dataframe as ddf
import time
import argparse

from sklearnex import patch_sklearn
patch_sklearn()


labels = ['adware', 'flooder', 'ransomware', 'dropper', 'spyware', 'packed',
          'crypto_miner', 'file_infector', 'installer', 'worm', 'downloader']
features = [f"feature_{x}" for x in range(2381)]


def log_container_info(prefix):
    print('------------------- environment variables -------------------')
    print(os.environ)
    print('------------------- environment variables -------------------')
    print('------------------- arguments -------------------')
    print(sys.argv)
    print('------------------- arguments -------------------')
    print('------------------- filesystem -------------------')
    for filename in glob.iglob(prefix + '**/**', recursive=True):
        print(filename)
    print('------------------- filesystem -------------------')


def process(prefix, k, chunk_size, x_name, y_name, label):
    y = ddf.read_parquet(f"{prefix}/processing/data/{y_name}",
                         compression="snappy", columns=[label])

    chunked_features = []
    for i in range(0, len(features), chunk_size):
        chunked_features.append(features[i:i+chunk_size])

    print(f"kbest for {label}")
    scores = []
    total_time = 0
    for i, chunk in enumerate(chunked_features):
        start = time.time()

        X = ddf.read_parquet(
            f"{prefix}/processing/data/{x_name}", compression="snappy", columns=chunk)
        selector = SelectKBest(chi2, k=k)
        selector.fit(X, y)
        scores += zip(chunk, selector.scores_)

        stop = time.time()
        total_time += stop-start
        print(f"i = {i+1:03} tpi = {total_time/(i+1):.2f}")

    print(f"save scores for {label}")
    with open(f"{prefix}/processing/output/scores-{label}.pkl", "wb") as f:
        f.write(dumps(scores))

    print('Finish the processing.')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("-prefix", type=str, default="/opt/ml")
    parser.add_argument("-k", action='store', default='all')
    parser.add_argument("-chunk-size", type=int, default=48)
    parser.add_argument("-x-name", type=str, default='x-train')
    parser.add_argument("-y-name", type=str, default='y-train')
    parser.add_argument("-label", type=str, choices=labels)
    args = parser.parse_args()

    log_container_info(args.prefix)
    k = args.k.isdecimal() and int(args.k) or args.k
    process(prefix=args.prefix, k=k, chunk_size=args.chunk_size, x_name=args.x_name,
            y_name=args.y_name, label=args.label)

    sys.exit(0)
